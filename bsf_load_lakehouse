#!/bin/bash

# ðŸš€ Lakehouse Loader Script
# Usage:
#   ./bsf-load-lakehouse.sh --mode <mode> [--option <option>]
#   modes: history, signals, candidates, all

MODE=""
OPTION=""

usage() {
    echo "Usage: $0 --mode <mode> [--option <option>]"
    echo
    echo "Required arguments:"
    echo "  --mode       Mode of operation: history, signals, candidates, all"
    echo
    echo "Optional arguments:"
    echo "  --option     Option to use: full or incremental"
    echo "               (only valid for history or all modes)"
    echo
    exit 1
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Parse args â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) usage ;;
        --mode) MODE="$2"; shift ;;
        --option) OPTION="$2"; shift ;;
        *) echo "âŒ Unknown parameter: $1"; usage ;;
    esac
    shift
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -z "$MODE" ]]; then
    echo "âŒ --mode is required"; usage
fi

if [[ "$MODE" != "history" && "$MODE" != "signals" && "$MODE" != "candidates" && "$MODE" != "all" ]]; then
    echo "âŒ Invalid --mode: $MODE. Allowed values: history, signals, candidates, all"
    usage
fi

if [[ "$MODE" == "history" || "$MODE" == "all" ]]; then
    if [[ -n "$OPTION" && "$OPTION" != "full" && "$OPTION" != "incremental" ]]; then
        echo "âŒ Invalid --option: $OPTION. Allowed values: full, incremental"
        usage
    fi
else
    if [[ -n "$OPTION" ]]; then
        echo "âš ï¸  Ignoring --option since --mode=$MODE"
        OPTION=""
    fi
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LOG_DIR=/var/log/bsf
mkdir -p "$LOG_DIR"
TS=$(date +"%Y%m%d_%H%M%S")

run_loader() {
    local run_mode=$1
    local run_option=$2

    PARAMS="mode_${run_mode}"
    if [[ -n "$run_option" ]]; then
        PARAMS="${PARAMS}_option_${run_option}"
    fi

    LOG_FILE="$LOG_DIR/bsf_load_${PARAMS}_${TS}.log"
    exec >> "$LOG_FILE" 2>&1

    echo "ðŸš€ Starting lakehouse load at $(date)"
    echo "ðŸ“¦ Mode: $run_mode"
    if [[ -n "$run_option" ]]; then
        echo "âš¡ï¸ Option: $run_option"
    fi

    # Activate Python venv
    source $HOME/.venv/python3.9_bsf/bin/activate

    # Build args
    PY_ARGS="--mode $run_mode"
    if [[ -n "$run_option" ]]; then
        PY_ARGS="$PY_ARGS --option $run_option"
    fi

    python3 /srv/jupyter/bsf_analysis/bsf_load_lakehouse.py $PY_ARGS

    echo "âœ… Lakehouse load finished at $(date)"

    # Keep last 10 logs for this mode/option
    ls -1t "$LOG_DIR"/bsf_load_mode_"${run_mode}"* 2>/dev/null | tail -n +8 | xargs -r rm -f
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Run mode(s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "$MODE" == "all" ]]; then
    run_loader "history" "$OPTION"
    run_loader "signals"
    run_loader "candidates"
else
    run_loader "$MODE" "$OPTION"
fi
