#!/bin/bash

# ğŸš€ Lakehouse Loader Script
# Usage:
#   ./bsf-load-lakehouse.sh --mode full [--option short]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MODE="candidates"
OPTION=""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Parse arguments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --mode)
            MODE="$2"
            shift
            ;;
        --option)
            OPTION="$2"
            shift
            ;;
        *)
            echo "âŒ Unknown parameter passed: $1"
            exit 1
            ;;
    esac
    shift
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Log setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LOG_DIR=/var/log/bsf
mkdir -p "$LOG_DIR"

TS=$(date +"%Y%m%d_%H%M%S")

# Use the option parameter if passed, else "all"
OPTION_NAME=${OPTION:-all}

PARAMS="mode_${MODE}_option_${OPTION_NAME}"
LOG_FILE="$LOG_DIR/bsf_load_${PARAMS}_${TS}.log"

# Redirect stdout/stderr
exec >> "$LOG_FILE" 2>&1
#set -x

# Keep last 10 logs
ls -1t "$LOG_DIR"/bsf_load_"${PARAMS}"_*.log 2>/dev/null | tail -n +11 | xargs -r rm -f

echo "ğŸš€ Starting lakehouse load at $(date)"
echo "ğŸ“¦ Mode: $MODE"
echo "â° Option: $OPTION_NAME"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Activate Python virtualenv â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
source $HOME/.venv/python3.9_bsf/bin/activate

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Run Python loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -n "$OPTION" ]]; then
    python3 /srv/jupyter/bsf_analysis/bsf_load_lakehouse.py --mode "$MODE" --option "$OPTION"
else
    python3 /srv/jupyter/bsf_analysis/bsf_load_lakehouse.py --mode "$MODE"
fi

echo "âœ… Lakehouse load finished at $(date)"
